# SmartLighting Simulator

Software to simulate devices (both sensors and actuators) for the SmartLighting Project. 

  - Uses Device Management Objects representation (Another project for SmartLighting**)
  - All communication through MQTT
  - Messages in JSON
  - Sensors values generated by external modules
  - Flask Web Server to visualize devices states (**TO BE REMOVED FROM THIS PROJECT**)

All configurations are made on a unique configuration file: **`devices_config.py`**

** **Device Management Platform**
> The DM Platform basically tries to represent every sensor/actuator in objects, being its resources their possible values/parameters. This representation is provided in a json file (**`objects-spec.jsonÂ´**).
> This simulator instantiates one instance of every object/resource stated as "mandatory". Other optional objects/resources need to be specified on the configuration file. (next section)


## Configuration File
 **`devices_config.py`**

> Enable debug mode
```sh
DEBUG = True
```
>MQTT Broker Configuration
```sh
BROKER_ADDRESS = '127.0.0.1'
BROKER_PORT = 1883
MQTT_TENANT = '/SM'
DEVICES_TOPIC = '/devices'
```
>Web Simulator Configuration (**TO BE REMOVED**)
```sh
ENABLE_SIMULATOR = False
WEB_ADDRESS = 'http://localhost:5000'
```
#### Devices Configuration

> Devices are in a python dictionary
```sh
DEVICES_CONFIG = { }
```

> Each device has the following configuration, where every key is optional.
```sh
Device_ID : {
        'objects': Objects List,
        'generators': Generators List,
        'web_ids': List of IDs on web simulator (TO BE REMOVED)
    }
```

> The objects list is a list of dictionaries containing the optional objects (mandatory are always instantiated) and its optional resources to be instantiated.
> Each of them contain the object ID and instance and optionally (if not specified, only mandatory resources will be instantiated) resource id and instance. Check the example beloow:
```sh
'motion_2': {
        'objects': [
            {
                'object_id': 3302,
                'object_inst': 0
            },
            {
                'object_id': 3302,
                'object_inst': 0,
                'resource_id': 5501,
                'resource_inst': 0
            }
        ]
}
```

> The Generators List, is also a list of python dictionaries, and its better described on the generators section.

## Generators

#### Random Generator
Values are randomly generated between specified min and max values.
##### Fields

  - **periodicity** - Periodicity of value generating in seconds
  - **min** - Minimum value to be generated
  - **max** - Maximum value to be generated

> Example
```sh
'motion_1': {
        'objects': [
            {
                'object_id': 3302,
                'object_inst': 0
            },
        ],
        'generators': [
            {
                'object_id': 3302,
                'object_inst': 0,
                'resource_id': 5500,
                'resource_inst': 0,
                'periodicity': 4,
                'min': 0,
                'max': 1,
                'type': 'random'
            },
        ]
}
```

#### Raw Data Generator
Values are read from a text file containing values in multiple columns corresponding to different sensors/data. Each line corresponds to a read.
##### Fields

  - **periodicity** - Periodicity of value generating in seconds
  - **args** - Additional arguments for this generator type
      - **file** -  File with the data (Mandatory) 
      - **column** - Column at which data is (Mandatory)
      - **convert_to_celsius** - Convert value to celsius (for temperature data) (Optional)
      - **skiplines** - Lines to skip at start (header) (Optional)

> Example
```sh
'hum_1': {
        'objects': [
            {
                'object_id': 3304,
                'object_inst': 0,
            }
        ],
        'generators': [
            {
                'object_id': 3304,
                'object_inst': 0,
                'resource_id': 5700,
                'resource_inst': 0,
                'periodicity': 10,
                'type': 'raw',
                'args': {
                    'file': 'datasets/office_data/LANGEVIN_DATA.txt',
                    'column': 6,
                }
            }
        ]
}
```

> Example data can be downloaded using script **getSampleData.sh**.
> Data is downloaded from [here](https://trynthink.github.io/buildingsdatasets/)

#### CSV Data Generator
Similar to Raw Data Generator (the only difference is that columns are separated by commas)

> Example
```sh
'tmp_2': {
        'objects': [
            {
                'object_id': 3303,
                'object_inst': 0,
            }
        ],
        'generators': [
            {
                'object_id': 3303,
                'object_inst': 0,
                'resource_id': 5700,
                'resource_inst': 0,
                'periodicity': 10,
                'type': 'csv',
                'args': {
                    'file': 'datasets/hvac_temp_humidity/trh-all-10min.csv',
                    'column': 1,
                    'convert_to_celsius': True,
                    'skiplines': 1
                }
            }
        ]
}
```

> Example data can be downloaded using script **getSampleData.sh**.
> Data is downloaded from [here](https://trynthink.github.io/buildingsdatasets/)

#### Motion Detector APP Generator
Values are read from a log file generated by [Motion Detector APP](https://play.google.com/store/apps/details?id=org.motion.detector).

(This APP can also generate live motion data to the simulator using [Tasker](https://play.google.com/store/apps/details?id=net.dinglisch.android.taskerm) and [this](https://play.google.com/store/apps/details?id=net.nosybore.mqttpublishplugin) plugin.
##### Fields

  - **periodicity** - Periodicity of value generating in seconds
  - **args** - Additional arguments for this generator type
      - **file** -  Log file with the data

> Example
```sh
'motion_10': {
        'objects': [
            {
                'object_id': 3302,
                'object_inst': 0
            },
        ],
        'generators': [
            {
                'object_id': 3302,
                'object_inst': 0,
                'resource_id': 5500,
                'resource_inst': 0,
                'periodicity': 4,
                'type': 'mda',
                'args': {
                    'file': 'datasets/motion1.log'
                }
            }
        ]
}
```

## Interacting with Simulator

The interaction is made using JSON objects over MQTT. Initially, each device subscribes only one topic with its device ID.
> Example topic
```sh
/SM/devices/motion_4
```
For configuration
```sh
MQTT_TENANT = '/SM'
DEVICES_TOPIC = '/devices'
```

More topics can be added, for both subscribing and publishing events, using the operations specified in the next section.

Currently, two types of messages are supported, **operation** and **event**, and they are described as follows.

### Operations

**subscribe_topic** - Adds new topic for device to subscribe.
> Example
```sh
{
    "operation": {
        "metaData": {
            "operation":"subscribe_topic"
        },
        "payloadData": {
            "value":"/example/topic"
        }
    }
}
```

**unsubscribe_topic** - Removes topic from device's subscriptions.
> Example
```sh
{
    "operation": {
        "metaData": {
            "operation":"unsubscribe_topic"
        },
        "payloadData": {
            "value":"/example/topic"
        }
    }
}
```

**unsubscribe_all** - Unsubscribe all topics (except the main one).
> Example
```sh
{
    "operation": {
        "metaData": {
            "operation":"unsubscribe_all"
        }
    }
}
```

**add_publish_topic** - Adds new topic for device to publish events.
> Example
```sh
{
    "operation": {
        "metaData": {
            "operation":"add_publish_topic"
        },
        "payloadData": {
            "value":"/example/topic"
        }
    }
}
```

**remove_publish_topic** -Remove topic from device's publishing topics.
> Example
```sh
{
    "operation": {
        "metaData": {
            "operation":"remove_publish_topic"
        },
        "payloadData": {
            "value":"/example/topic"
        }
    }
}
```

**remove_publish_all** - Removes all topics from publishing topics.
> Example
```sh
{
    "operation": {
        "metaData": {
            "operation":"remove_publish_all"
        }
    }
}
```

**report_device_info** - Get information about device. It publishes the information on the topic provided by "publish_on".
> Example
```sh
{
    "operation": {
        "metaData": {
            "operation":"report_device_info"
        },
        "payloadData": {
            "publish_on":"/topic/to/publish/the/info"
        }
    }
}
```



### Events
Devices report any change on a resource, each time it changes, generating an event in the following form:
```sh
{
    "event": {
        "payloadData": { 
            "device" "motion_1"
            "object": 3302,
            "object_instance" 0,
            "resource": 5500,
            "resource_instance": 0,
            "value": 1
        }
    }
}
```

To change a resource value, a JSON object can be sent to any of the subscribed topics, on two possible forms. One specifies the object and resource on the message itself, as follows:
```sh
{
    "event": {
        "metaData": {
            "operation":"set"
        },
        "correlationData": {
            "object": 1501,
            "object_instance" -1,
            "resource": 15011,
            "resource_instance": -1,
        }
        "payloadData": { 
            "value": 15
        }
    }
}
```
Or the objects and resources can be specified on the topic (subscribed before), and the message would consist on the following:
```sh
{
    "event": {
        "metaData": {
            "operation":"set"
        },
        "payloadData": { 
            "value": 15
        }
    }
}
```
And the topic:
```sh
/SM/devices/device_id/1501/*/15011/*
```
> The value -1 (or * if on the topic) can be set on any of the values in the "correlationData" to match all the objects, resources or its instances.